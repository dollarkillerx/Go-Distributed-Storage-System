Cephåˆ†å¸ƒå¼å­˜å‚¨
===
### ç‰¹ç‚¹:
éƒ¨ç½²ç®€å•
å¯é æ€§é«˜
æ€§èƒ½é«˜
åˆ†å¸ƒå¼,å¯æ‰©å±•æ€§å¼º
å¤šè¯­è¨€
å¼€æº
![](./README/ceph.png)

### CephåŸºç¡€ç»„å»º
- OSD:
    - ç”¨äºé›†ç¾¤ä¸­æ‰€æœ‰æ•°æ®ä¸å¯¹è±¡çš„å­˜å‚¨:å­˜å‚¨/å¤åˆ¶/å¹³è¡¡/æ¢å¤æ•°æ®ç­‰ç­‰
- Monitor:
    - ç›‘æ§é›†ç¾¤çŠ¶æ€,ç»´æŠ¤cluster MAPè¡¨,ä¿è¯é›†ç¾¤æ•°æ®ä¸€è‡´æ€§
- MDS:(å¯é€‰)
    - ä¿æŒæ–‡ä»¶ç³»ç»ŸæœåŠ¡çš„å…ƒæ•°æ®(OBJ.Blockä¸éœ€è¦è¯¥æœåŠ¡)
- GW:
    - æä¾›ä¸AmazonS3å’ŒSwiftå…¼å®¹çš„RESTful APIçš„gatewayæœåŠ¡
    
### AWS S3 æœ¯è¯­
- Region: å­˜å‚¨æ•°æ®æ‰€åœ¨çš„åœ°ç†åŒºåŸŸ
- Endpoint: å­˜å‚¨æœåŠ¡å…¥å£,WebæœåŠ¡å…¥å£ç‚¹URL
- Bucket: å­˜å‚¨æ¡¶S3ä¸­ç”¨äºå­˜å‚¨å¯¹è±¡çš„å®¹å™¨
- Object: å¯¹è±¡æ˜¯S3ä¸­å­˜å‚¨çš„åŸºæœ¬å®ä½“,ç”±å¯¹è±¡æ•°æ®å’Œå…ƒæ•°æ®ç»„æˆ
- Key: keyæ˜¯å­˜å‚¨æ¡¶çš„å”¯ä¸€æ ‡è¯†ç¬¦,æ¡¶å†…çš„æ¯ä¸ªå¯¹è±¡éƒ½åªèƒ½æœ‰ä¸€ä¸ªkey

### æœåŠ¡å™¨æ¶æ„å˜è¿
![](./README/ccs.png)

### Goç®¡ç†Cephé›†ç¾¤
ä¾èµ–
``` 
vgo get gopkg.in/amz.v1/aws
vgo get gopkg.in/amz.v1/s3
```
``` 
package ceph

import (
	"gopkg.in/amz.v1/aws"
	"gopkg.in/amz.v1/s3"
)

var (
	CephConn *s3.S3
)

func init() {
	// åˆå§‹åŒ–cephä¿¡æ¯
	auth := aws.Auth{
		AccessKey: "",
		SecretKey: "",
	}
	region := aws.Region{
		Name:"default",
		EC2Endpoint:"http://127.0.0.1:9080",
		S3Endpoint:"http://127.0.0.1:9080",
		S3BucketEndpoint:"",
		S3LocationConstraint:false, // æ²¡æœ‰åŒºåŸŸé™åˆ¶
		S3LowercaseBucket:false, // bucketæ²¡æœ‰å¤§å°å†™é™åˆ¶
		Sign:aws.SignV2,
	}
	// åˆ›å»ºğŸ”“s3ç±»å‹è¿æ¥
	CephConn = s3.New(auth, region)
}

// è·å–æŒ‡å®šBucker
func GetCephBucker(bucket string)*s3.Bucket {
	return CephConn.Bucket(bucket)
}
```

### cephå°ç»“
- åˆ›å»ºbucket
``` 
	bucker := ceph.GetCephBucker("testbucket1")
	// åˆ›å»ºä¸€ä¸ªæ–°çš„bucket
	err := bucker.PutBucket(s3.PublicRead) // å‚æ•°æƒé™
```
- ä¸Šä¼ æ–‡ä»¶
``` 
	filename := "test.txt"
	bucker := ceph.GetCephBucker("userfile")
	cephPath := "/ceph/" + filename
	bytes, _ := ioutil.ReadFile(filename)
	bucker.Put(cephPath,bytes,"octet-stream",s3.PublicRead)
```
- ä¸‹è½½æ–‡ä»¶
``` 
bucker := ceph.GetCephBucker("userfile")
cephPath := "/ceph/test.txt"
data, _ := bucker.Get(cephPath)
ioutil.WriteFile("hello.text",data,00666)
```